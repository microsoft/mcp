parameters:
- name: DependsOn
  type: object
  default: []
- name: ServerName
  type: string

jobs:
- job:
  displayName: "Sign and Pack VSIX"
  dependsOn: ${{ parameters.DependsOn }}
  condition: and(succeeded(), ne(variables['NoPackagesChanged'], 'true'))
  steps:
  - checkout: self

  # Download the signed MCP server binaries for this OS
  - download: current
    artifact: $(PipelineArtifactName)_signed
    displayName: "Download signed MCP server binaries"

  - task: NodeTool@0
    displayName: "Use Node.js 20.x"
    inputs:
      versionSpec: 20.x

  # --- VS Code Extension Packaging Steps ---

  - pwsh: >
      eng/scripts/Pack-Vsix.ps1
      -ServerName '${{ parameters.ServerName }}'
      -ArtifactsPath '$(Pipeline.Workspace)/$(PipelineArtifactName)_signed'
      -OutputPath '$(Build.ArtifactStagingDirectory)'
    displayName: "Copy signed MCP server binaries to VSIX"

  - template: pipelines/steps/azd-vscode-signing.yml@azure-sdk-build-tools
    parameters:
      Path: $(Build.ArtifactStagingDirectory)
      Pattern: '*.signature.p7s'

  - template: /eng/common/pipelines/templates/steps/publish-1es-artifact.yml
    parameters:
      ArtifactPath: $(Build.ArtifactStagingDirectory)
      ArtifactName: vsix_packages_signed
