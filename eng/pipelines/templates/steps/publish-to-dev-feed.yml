parameters:
  - name: PathToArtifacts
    type: string
  - name: Registry
    type: string
  - name: Tag
    type: string
  - name: CustomEndpoint
    type: string
    default: ''
  - name: Access
    type: string
    default: 'public'

steps:
  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml

  - template: /eng/common/pipelines/templates/steps/create-authenticated-npmrc.yml
    parameters:
      npmrcPath: ${{parameters.PathToArtifacts}}/.npmrc
      registryUrl: ${{parameters.Registry}}
      ServiceConnection: ${{parameters.CustomEndpoint}}

  - pwsh: |
      $tgzFiles = Get-ChildItem -Path . -Filter *.tgz -Recurse
      | Sort-Object FullName

      if ($tgzFiles.Count -eq 0) {
        Write-Host "No .tgz files found in ${{parameters.PathToArtifacts}}"
        exit 1
      }

      Write-Host "Publishing the following files to ${{parameters.Registry}}:"
      foreach ($file in $tgzFiles) {
        Write-Host "  - $($file.FullName)"
      }

      $access = '${{parameters.Access}}'
      $tag = '${{parameters.Tag}}'

      foreach ($file in $tgzFiles) {
        $command = "npm publish '$file' --loglevel verbose"

        if (![string]::IsNullOrEmpty($access)) {
          $command += " --access $access"
        }

        if (![string]::IsNullOrEmpty($tag)) {
          $command += " --tag '$tag'"
        }

        Write-Host "> $command"
        Invoke-Expression $command
        if (!$?) {
          exit 1
        }
      }
    displayName: Publish packages to dev feed
    workingDirectory: ${{parameters.PathToArtifacts}}
