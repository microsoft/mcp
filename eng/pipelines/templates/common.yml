parameters:
- name: ServerName
  type: string
  default: ''
- name: PublishTarget
  type: string
  default: none
  values: [none, internal, public ]
- name: RunLiveTests
  type: boolean
  default: false
- name: IncludeNative
  type: boolean
  default: false
- name: PackageDocker
  type: boolean
  default: false
- name: PackageVSIX
  type: boolean
  default: false
- name: PackagePyPI
  type: boolean
  default: false
- name: TestTimeoutInMinutes
  type: number
  default: 30
- name: IsTestPipeline
  type: boolean
  default: false
  # Test pipelines (e.g. Template.Mcp.Server) can release to public feeds, but they always use prerelease tags and automatically close their version bump PRs
  # This allows us to run them multiple times from the same commit without hitting github release tag or package deployment conflicts

resources:
  repositories:
  - repository: azure-sdk-build-tools
    type: git
    name: internal/azure-sdk-build-tools
    ref: refs/tags/azure-sdk-build-tools_20251112.1

extends:
  template: /eng/pipelines/templates/1es-redirect.yml
  parameters:
    # We pick a single internal pipeline to use for autoBaseline. This should be a pipeline that runs often on main with normal code paths, i.e. not Template.Mcp.Server
    autoBaseline: ${{ and(eq(variables['Build.DefinitionName'], 'mcp - Azure.Mcp.Server'), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['System.TeamProject'], 'internal')) }}
    stages:
    - stage: Initialize
      pool:
        name: $(LINUXPOOL)
        image: $(LINUXVMIMAGE)
        os: linux
      variables:
      - template: /eng/pipelines/templates/variables/image.yml
      - template: /eng/pipelines/templates/variables/globals.yml
      jobs:
      - job: Initialize
        steps:
        - task: AzureCLI@2
          name: UseSovIdentity
          inputs:
            azureSubscription: 'azure-mcp-gov-test'
            addSpnToEnvironment: true
            scriptType: 'pscore'
            scriptLocation: 'inlineScript'
            inlineScript: |
              Write-Host "We have a running cli!"
              $context = az account show
              Write-Host "Current account context:"
              Write-Host $context

              Write-Host "az cloud set --name AzureUSGovernment"
              az cloud set --name AzureUSGovernment

              Write-Host "Accessing storage using az cli. acct: pahallistest"
              $storageAccountName = "pahallistest"

              Write-Host "az storage account list"
              az storage account list --auth-mode login

              Write-Host "az storage blob list --account-name '$storageAccountName' --container-name `"stuff`"  --auth-mode login"
              az storage blob list --account-name $storageAccountName --container-name "stuff" --auth-mode login
